<!DOCTYPE html>

<html>
  <head>
  	<meta charset="utf-8">
  	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>lists</title>
  </head>
 
  <body>   
    <table>
      <tr id = "container">
      </tr>
    </table>
  </body>
  <script type="text/javascript" src="/lib/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/PapaParse/papaparse.js"></script>
  <script>
    var lists = {};
    var datas = {};
    
    //var headers = {landfill:true, numtotes:true, maxtotes:true, maxcans:true, reliability:true};
    
    function init(){
      fetchData("HEAD");
    }
    
    function parseData(number){
      var data = datas[number];
      var matchData = data.slice(10);
      console.log(data);
      console.log(number);
      
      var element = document.createElement("li");
      element.className="list-entry";
      element.id = number;
      
      element.innerHTML =
        '<div class="entry-index">index</div>' +
        '<div class="entry-number">number</div>' +
        '<div id="landfill" class="entry-field">LF</div>' +
        '<div id="numtotes" class="entry-field">NT</div>' +
        '<div id="maxtotes" class="entry-field">MT</div>' +
        '<div id="maxcans" class="entry-field">MC</div>' +
        '<div id="reliability" class="entry-field">RL</div>';
          
      element.id = number;
      
      //now to set the fields
      element.querySelector(".entry-number").innerHTML = number;
      element.querySelector("#landfill.entry-field").innerHTML = average(matchData, 4);
      element.querySelector("#numtotes.entry-field").innerHTML = average(matchData, 9);
      element.querySelector("#maxtotes.entry-field").innerHTML = average(matchData, 8);
      element.querySelector("#maxcans.entry-field").innerHTML = average(matchData, 7);
      element.querySelector("#reliability.entry-field").innerHTML = reliablityAnalysis(matchData);

      return element;
    }
    
    function reliablityAnalysis(data){
      var last_numtotes = parseInt(data[0][9]);
      var last_maxtote = parseInt(data[0][8]);
      var last_maxcan = parseInt(data[0][7]);
      
      var delta_numtotes = 0;
      var delta_maxtote = 0;
      var delta_maxcan = 0;
      
      for (i = 0; i < data.length; i++) {
        try{
          numtotes = parseInt(data[i][9]);
          maxtote = parseInt(data[i][8]);
          maxcan = parseInt(data[i][7]);
          
          delta_numtotes += Math.abs(numtotes - last_numtotes);         
          delta_maxtote += Math.abs(maxtote - last_maxtote);
          delta_maxcan += Math.abs(maxcan - last_maxcan);

          last_numtotes = numtotes;
          last_maxtote = maxtote;
          last_maxcan = maxcan;
        }catch(e){}
      }
      
      var delta = delta_maxtote + delta_maxcan + delta_numtotes;
      return delta;
    }
    
    function average(data, col){
      sum = 0;
      num = 0;
      
      for (i = 0; i < data.length; i++) {
        try{
          d = parseInt(data[i][col]);
          sum += d;
          num += 1;
        }catch(e){}
      }
      
      return sum / num; 
    }
    
    function displayInfo(number) { 
        document.getElementById("info_image").src = "/?type=picture&number=" + number;
  
        //do http request here
        url = "/?type=data&number=" + number;
        $.get(url, function(data, status) {
  
            data = data.split("\n");
  
            tbl = document.getElementById('match_data');
  
            lables = tbl.children[0].children[0];
            tbl.children[0].innerHTML = "";
            tbl.children[0].appendChild(lables);
  
            for (i = 10; i < data.length; i++) {
                row = tbl.insertRow();
                row.className = "data_entry";
                info = data[i].split(",");
                for (d = 0; d < info.length; d++) {
                    cell = row.insertCell();
                    cell.innerHTML = info[d];
                }
            }
            pit = data[2].split(",");
            document.getElementById('drive').innerHTML = pit[1];
            document.getElementById('comment').innerHTML = pit[10];
  
            black = "black";
            grey = "grey";
            
            document.getElementById('platform').style.color = pit[11] == "1" ? black : grey;
            
            document.getElementById('totes').style.color = pit[2] == "1" ? black : grey;
            document.getElementById('cans').style.color = pit[3] == "1" ? black : grey;
            document.getElementById('litter').style.color = pit[4] == "1" ? black : grey;
  
            document.getElementById('pneumatics').style.color = pit[5] == "1" ? black : grey;
            document.getElementById('camera').style.color = pit[6] == "1" ? black : grey;
            document.getElementById('encoders').style.color = pit[7] == "1" ? black : grey;
            document.getElementById('range').style.color = pit[8] == "1" ? black : grey;
            document.getElementById('gyro').style.color = pit[9] == "1" ? "black" : grey;
  
            document.getElementById("rank").innerHTML = 100 * rankBy_Votes(data);
  
        }).fail(function() {
            alert('"being scouting lead is suffering"');
        });
    }
    
    function fetchData(list_id, element){
      //first get robot list
      //then fetch robot data files and call parse data for each
      //list data
      
      url = "/?type=list&id="+list_id;
      $.get(url, function(csv, status) {
        var data = Papa.parse(csv).data;
  
        //console.log(csv);
        //console.log(data);
        
        lists[list_id] = data;
        
        var list_element = document.createElement("ul");
        list_element.className = "robot_list";
        list_element.id = list_id;
        var table_element = document.createElement("tr");
        table_element.appendChild(list_element);
        document.body.querySelector("#container").appendChild(table_element);
             
        list_element.appendChild(list_headers());
        for(index in data){
          var entry = data[index];
          var number = entry[0];
          
          //console.log(index);
          //console.log(entry);
          //console.log(number);
          
          url = "/?type=data&number="+number;
          $.get(url, function(robotData_CSV, status) {
            //console.log(number); for some reason number is undefined
            //console.log(list_element);
                        
            var stuff = Papa.parse(robotData_CSV).data;
            var number = stuff[2][0];

            datas[number] = stuff;
            
            var element = parseData(number);
            list_element.appendChild(parseData(number));
          });
          
        }
      }).fail(function() {
        alert();
      });
          
      function list_headers(){
        var element = document.createElement("li");
        element.className="list-entry";
        element.innerHTML =
          '<div class="entry-index"></div>' +
          '<div class="entry-number">#</div>' +
          '<div id="landfill" class="entry-field">LF</div>' +
          '<div id="numtotes" class="entry-field">NT</div>' +
          '<div id="maxtotes" class="entry-field">MT</div>' +
          '<div id="maxcans" class="entry-field">MC</div>' +
          '<div id="reliability" class="entry-field">RL</div>';
        return element;
      }
    }
    
    init();
  
  </script>
  
  
</html>
